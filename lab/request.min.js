var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};Promise.prototype.finally=function(e){var t=this.constructor;return this.then(function(n){return t.resolve(e()).then(function(){return n})},function(n){return t.resolve(e()).then(function(){throw n})})};var toString=Object.prototype.toString;function isFunction(e){return"[object Function]"===toString.call(e)}function isAbsoluteURL(e){return/^([a-z][a-z\d\+\-\.]*:)?\/\//i.test(e)}function combineURLs(e,t){return t?e.replace(/\/+$/,"")+"/"+t.replace(/^\/+/,""):e}function merge(){var e=arguments,t={};for(var n=function(){var n=e[r];n&&Object.keys(n).forEach(function(e,r){var o,i;o=n[e],"object"===_typeof(t[i=e])&&"object"===(void 0===o?"undefined":_typeof(o))?t[i]=merge(t[i],o):t[i]=o})},r=0,o=arguments.length;r<o;r++)n();return t}function InterceptorManager(){this.handlers=[]}InterceptorManager.prototype.use=function(e,t){return this.handlers.push({fulfilled:e,rejected:t}),this.handlers.length-1},InterceptorManager.prototype.eject=function(e){this.handlers[e]&&(this.handlers[e]=null)},InterceptorManager.prototype.forEach=function(e){this.handlers.forEach(function(t){null!==t&&e(t)})};var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var working=null,Queue=function(){function e(t){_classCallCheck(this,e),this.executing=[],this.waiting=[],this.immediately=[],this.num=0,this.max=t}return _createClass(e,[{key:"getMax",value:function(){return isFunction(this.max)?this.max():max}},{key:"push",value:function(e){var t=++this.num,n=function(){var n=this;return new Promise(e).then(function(){n.complete(t)})};return n.id=t,this.waiting.push(n),this.arrange(),t}},{key:"arrange",value:function(){this.executing.length+this.immediately.length<this.getMax()&&this.waiting.length&&(this.immediately.push(this.waiting.shift()),working||(working=!0,Promise.resolve(this).then(function(e){e.work()})))}},{key:"work",value:function(){for(var e=0;e<this.immediately.length;e++){var t={promise:this.immediately[e].call(this),id:this.immediately[e].id};this.executing.push(t)}this.immediately=[],working=!1}},{key:"complete",value:function(e){for(var t=0,n=this.executing.length;t<n;t++)if(e===this.executing[t].id)return this.executing.splice(t,1),void this.arrange()}}]),e}(),defaults={concurrency:10},_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},queue=new Queue(function(){return defaults.concurrency});function wxRequest(e){var t=new Promise(function(t,n){var r=null,o=!1;e.cancelToken&&e.cancelToken.promise.catch(function(e){n(e),o=!0,r&&r.abort()}),queue.push(function(i,s){if(o)return i();r=wx.request(_extends({},e,{success:function(e){i(),t(e)},fail:function(e){i(),n(e)}}))})});return e.cancelToken&&(t=Promise.race([t,e.cancelToken.promise])),t}var _createClass$1=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();function _classCallCheck$1(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var methods=["OPTIONS","GET","HEAD","POST","PUT","DELETE","TRACE","CONNECT"],Request=function(){function e(t){_classCallCheck$1(this,e),delete t.concurrency,this.defaults=t,this.interceptors={request:new InterceptorManager,response:new InterceptorManager}}return _createClass$1(e,[{key:"request",value:function(e){"string"==typeof e&&(e=merge({url:arguments[0]},arguments[1])),(e=merge(this.defaults,{method:"get"},e)).method=e.method.toUpperCase(),e.baseURL&&!isAbsoluteURL(e.url)&&(e.url=combineURLs(e.baseURL,e.url));var t=Promise.resolve(e),n=[wxRequest,null];for(this.interceptors.request.forEach(function(e){n.unshift(e.fulfilled,e.rejected)}),this.interceptors.response.forEach(function(e){n.push(e.fulfilled,e.rejected)});n.length;)t=t.then(n.shift(),n.shift());return t}}]),e}();function _classCallCheck$2(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Request.defaults=defaults,Request.methods=methods,methods.forEach(function(e){Request.prototype[e.toLowerCase()]=function(t,n){return this.request(merge({url:t,method:e},n))}});var Cancel=function e(t){_classCallCheck$2(this,e),this.message=t};function CancelToken(e){if("function"!=typeof e)throw new TypeError("executor must be a function.");var t;this.promise=new Promise(function(e,n){t=n});var n=this;e(function(e){n.reason||(n.reason=new Cancel(e),t(n.reason))})}function createInstance(e){var t=new Request(e),n=t.request.bind(t);return Request.methods.forEach(function(e){n[e.toLowerCase()]=t[e.toLowerCase()].bind(t)}),n.CancelToken=CancelToken,n.defaults=t.defaults,n.interceptors=t.interceptors,n}Cancel.__CANCEL__=!0,CancelToken.source=function(){var e;return{token:new CancelToken(function(t){e=t}),cancel:e}};var instance=createInstance(merge(Request.defaules,{}));instance.create=function(e){return createInstance(utils.merge(defaults,e))},instance.Request=Request;export default instance;
